<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinician Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745; /* Green */
            --warning: #ffc107;
            --text-main: #333;
            --text-muted: #6c757d;
            --border: #e9ecef;
            --shadow: 0 4px 6px rgba(0,0,0,0.04);
        }

        body {
            background-color: var(--bg);
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
        }

        /* --- LAYOUT GRID --- */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            align-items: start;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .container.nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95%;
            margin: 0 auto;
        }
        .logo { font-weight: 700; font-size: 1.2rem; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        
        .btn { border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; text-decoration: none; display: inline-block;}
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg); }
        .btn-primary { background: var(--primary); color: white; padding: 8px 16px; }
        .btn-secondary { background: var(--text-muted); color: white; padding: 6px 12px; }
        .pill { background: #eef2ff; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .ghost-pill { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        /* --- STATS SIDEBAR --- */
        .stats-sidebar { display: flex; flex-direction: column; gap: 16px; }
        .stat-card-solid {
            padding: 24px 20px;
            border-radius: 12px;
            color: white;
            box-shadow: var(--shadow);
            text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 140px;
        }
        .stat-card-solid h3 { margin: 0 0 10px 0; font-size: 0.9rem; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card-solid h1 { margin: 0; font-size: 3.5rem; font-weight: 700; line-height: 1; }
        .stat-card-solid p { margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.8; }
        .bg-primary { background-color: var(--primary); }
        .bg-danger { background-color: var(--danger); }
        .bg-warning { background-color: var(--warning); color: #333; }

        /* --- MAIN CARDS --- */
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .col-span-2 { grid-column: span 2; }
        .text-muted { color: var(--text-muted); }
        .flex-between { justify-content: space-between; }
        h2, h3 { margin-top: 0; }
        
        .patient-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .patient-table th { text-align: left; color: var(--text-muted); font-size: 0.8rem; padding-bottom: 10px; border-bottom: 2px solid var(--bg); }
        .patient-table td { padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-risk { background: #ffebee; color: var(--danger); }
        .status-stable { background: #e8f5e9; color: #2e7d32; }

        /* --- CHART (UPDATED) --- */
        .chart-container {
            display: flex; align-items: flex-end; justify-content: space-around;
            height: 200px; /* Increased height */
            background: var(--bg); border-radius: 8px; padding: 20px 15px 10px 15px; 
            margin-top: 15px;
            position: relative;
        }
        .bar-group { 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end; 
            height: 100%; width: 10%; 
        }
        
        /* Bar styles */
        .bar { 
            width: 100%; 
            border-radius: 4px; 
            transition: height 0.4s ease-out, background-color 0.3s; 
            min-height: 2px; /* Ensure visible even if 0 */
            margin-bottom: 2px;
        }
        
        /* Specific Bar Defaults */
        .bar-active { background: #ccc; } 
        .bar-sleep { background: #eee; }
        
        .axis-label { margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        /* --- TIMELINE --- */
        .timeline-item { border-left: 2px solid var(--border); padding-left: 15px; margin-bottom: 15px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 5px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; }

        /* --- FORM --- */
        input, select, textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; }
        .w-full { width: 100%; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.5); display: none;
            justify-content: center; align-items: center;
            z-index: 2000; backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        body.high-contrast { --bg: #000; --surface: #000; --text-main: #fff; --border: #333; --shadow: none; }
        @media (max-width: 1024px) {
            .dashboard-layout { grid-template-columns: 1fr; }
            .stats-sidebar { flex-direction: row; flex-wrap: wrap; }
            .stat-card-solid { flex: 1; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container nav-content">
            <div class="logo">CareCompass <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: normal;">| Clinician Mode</span></div>
            <div class="flex-row">
                <span class="pill ghost-pill">Live overview</span>
                <span>Dr. House</span>
                <button class="btn btn-outline" onclick="toggleContrast()" style="padding: 5px 12px; width:auto;">üëÅÔ∏è</button>
                <a href="index.html" class="btn btn-outline" style="padding: 5px 12px;">‚Üê Home</a>
                <a href="index.html" class="btn btn-outline" style="padding: 5px 15px;">Logout</a>
            </div>
        </div>
    </header>

    <div class="dashboard-layout">
        <aside class="stats-sidebar">
            <div class="stat-card-solid bg-primary">
                <h3>Total Patients</h3>
                <h1 id="statTotal">3</h1>
                <p id="statTotalCopy">New this month</p>
            </div>
            <div class="stat-card-solid bg-danger">
                <h3>Critical Alerts</h3>
                <h1 id="statAlerts">1</h1>
                <p>Requires review</p>
            </div>
            <div class="stat-card-solid bg-warning">
                <h3>Pending Reports</h3>
                <h1 id="statReports" style="color: #333;">12</h1>
                <p style="color: #333;">End of month</p>
            </div>
        </aside>

        <main class="main-content">
            <div class="card col-span-2">
                <div class="flex-between flex-row">
                    <div>
                        <div class="pill" style="margin-bottom: 8px;">Morning rounds</div>
                        <h2 style="margin-bottom: 6px;">Risk & Report Overview</h2>
                        <p class="text-muted" style="margin:0;">Action-first dashboard with PDF export, live search, and smart correlations.</p>
                    </div>
                    <div>
                         <button class="btn btn-primary" onclick="openAddPatient()">+ New Patient</button>
                    </div>
                </div>
            </div>

            <div class="card" style="min-height: 400px;">
                <div class="flex-between flex-row" style="gap: 10px; margin-bottom: 15px;">
                    <h3>Patient Overview</h3>
                    <div class="flex-row">
                        <input id="searchBox" type="text" placeholder="Search..." style="width: 140px; margin-bottom: 0;">
                        <span class="pill ghost-pill" id="filterPill" style="display:none;">Filter: all</span>
                    </div>
                </div>
                <table class="patient-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody"></tbody>
                </table>
            </div>

            <div class="card">
                <div class="flex-between flex-row" style="margin-bottom: 15px;">
                    <h3>Analysis: <span id="analysisName">Alex Doe</span></h3>
                    <div class="flex-row">
                        <select id="analysisSelect" style="width: 120px; margin-bottom:0;" onchange="selectAnalysis(this.value)"></select>
                    </div>
                </div>

                <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: var(--text-muted); font-size: 0.7rem; letter-spacing: 1px;">INSIGHT ENGINE:</strong>
                    <p style="font-size: 0.85rem; margin: 5px 0 0 0;">Recent pattern suggests irregular sleep cycles.</p>
                </div>

                <p id="chartLegend" class="text-muted" style="text-align: center; font-size: 0.8rem; margin:0;">
                    Loading graph...
                </p>
                
                <div class="chart-container" id="chart">
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">M</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">T</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">W</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">T</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">F</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">S</div></div>
                    <div class="bar-group"><div class="bar bar-active"></div><div class="bar bar-sleep"></div><div class="axis-label">S</div></div>
                </div>

                <div style="margin-top: 20px;">
                    <div id="analysisTimeline" class="timeline" style="margin: 14px 0; max-height: 100px; overflow-y: auto;"></div>
                    <textarea id="clinicianNote" rows="2" placeholder="Add recommendation..."></textarea>
                    <button class="btn btn-primary w-full" onclick="saveClinicianNote()">Update</button>
                </div>
            </div>
        </main>
    </div>

    <div id="addPatientModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">Add Patient</h3>
            <label>Name</label>
            <input id="newPName" placeholder="Alex Doe" />
            <label>ID (no spaces)</label>
            <input id="newPID" placeholder="alex" />
            <label>Diagnosis</label>
            <input id="newPDiag" placeholder="ASD Level 2" />
            <label>Status</label>
            <select id="newPStatus">
                <option value="stable">Stable</option>
                <option value="risk">Risk</option>
            </select>
            <div class="flex-row" style="margin-top: 20px;">
                <button class="btn btn-primary w-full" onclick="savePatient()">Save Patient</button>
                <button class="btn btn-outline w-full" onclick="closeAddPatient()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DOM ELEMENTS ---
        const patientTableBody = document.getElementById('patientTableBody');
        const searchBox = document.getElementById('searchBox');
        const analysisSelect = document.getElementById('analysisSelect');
        const analysisName = document.getElementById('analysisName');
        const chartEl = document.getElementById('chart');
        const chartLegend = document.getElementById('chartLegend');
        const modal = document.getElementById('addPatientModal');
        const filterPill = document.getElementById('filterPill');

        // --- 3. LOGIC ---
        function hydrateStats() {
            const patients = CareData.getPatients();
            const count = patients.length;
            const risks = patients.filter(p => p.status === 'risk').length;
            document.getElementById('statTotal').textContent = count;
            document.getElementById('statAlerts').textContent = risks;
        }

        function renderPatients(filter = '') {
            const patients = CareData.getPatients();
            const term = filter.toLowerCase();
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(term) || p.id.includes(term)
            );
            
            if(filterPill) filterPill.textContent = term ? `Filter: "${filter}"` : 'Filter: all';

            patientTableBody.innerHTML = filtered.map(p => {
                const badge = p.status === 'risk' ? 'status-risk' : 'status-stable';
                const label = p.status === 'risk' ? 'Risk' : 'Stable';
                return `
                    <tr>
                        <td><strong>${p.name}</strong><br><span class="text-muted" style="font-size:0.8em">#${p.id.toUpperCase()}</span></td>
                        <td>${p.diagnosis}</td>
                        <td><span class="status-badge ${badge}">${label}</span></td>
                        <td><button class="btn btn-outline" style="padding:4px 8px; font-size:0.8rem" onclick="selectAnalysis('${p.id}')">View</button></td>
                    </tr>
                `;
            }).join('');
        }

        function populateAnalysisSelect() {
            const patients = CareData.getPatients();
            analysisSelect.innerHTML = patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            // Auto-select first if available
            if(patients.length > 0) selectAnalysis(patients[0].id);
        }

        function selectAnalysis(id) {
            analysisSelect.value = id;
            const patients = CareData.getPatients();
            const p = patients.find(x => x.id === id);
            if(!p) return;

            analysisName.textContent = p.name;
            renderTimeline(id);
            renderChart(id, p.status);
        }

        // --- THE FIX: GRAPH LOGIC ---
        function renderChart(id, status) {
            const agg = CareData.aggregateWeekly(id);
            const data = { sleeps: agg.sleeps, actives: agg.behaviors };
            const bars = chartEl.querySelectorAll('.bar-group');
            const maxVal = 24; // Fixed scale for 24h day

            // Colors
            let activeColor, sleepColor, legendHtml;
            if(status === 'risk') {
                activeColor = '#dc3545'; // Red
                sleepColor = '#ffcdd2'; // Light Red
                legendHtml = `<span style="color:${sleepColor}">‚óº Sleep</span> vs <strong style="color:${activeColor}">‚óº Active</strong> (Risk Pattern)`;
            } else {
                activeColor = '#28a745'; // Green
                sleepColor = '#c3e6cb'; // Light Green
                legendHtml = `<span style="color:${sleepColor}">‚óº Sleep</span> vs <strong style="color:${activeColor}">‚óº Active</strong> (Stable)`;
            }
            chartLegend.innerHTML = legendHtml;

            bars.forEach((group, idx) => {
                const activeBar = group.querySelector('.bar-active');
                const sleepBar = group.querySelector('.bar-sleep');

                // Apply Colors
                activeBar.style.backgroundColor = activeColor;
                sleepBar.style.backgroundColor = sleepColor;

                // Animate Height
                // Force a reset to 0 to trigger CSS transition
                activeBar.style.height = '0%';
                sleepBar.style.height = '0%';

                // Calculate % height
                const hActive = (data.actives[idx] / maxVal) * 100;
                const hSleep = (data.sleeps[idx] / maxVal) * 100;

                setTimeout(() => {
                    activeBar.style.height = `${hActive}%`;
                    sleepBar.style.height = `${hSleep}%`;
                }, 50);
            });
        }

        function renderTimeline(id) {
            const timeline = document.getElementById('analysisTimeline');
            const logs = CareData.getLogs(id);
            timeline.innerHTML = logs.map(l => `
                <div class="timeline-item">
                    <strong>${l.mood || 'Event'}</strong>
                    <p class="text-muted" style="margin:0; font-size:0.8rem">${l.note || 'No note'}</p>
                </div>
            `).join('');
        }

        function saveClinicianNote() {
            const note = document.getElementById('clinicianNote').value.trim();
            if (!note) return alert('Please enter a note');
            CareData.addClinicianNote(analysisSelect.value, note);
            document.getElementById('clinicianNote').value = '';
            alert('Note saved');
        }

        // --- MODAL & UI ---
        function openAddPatient() { modal.style.display = 'flex'; }
        function closeAddPatient() { modal.style.display = 'none'; }
        
        async function savePatient() {
            const name = document.getElementById('newPName').value;
            const id = document.getElementById('newPID').value;
            const diagnosis = document.getElementById('newPDiag').value;
            const status = document.getElementById('newPStatus').value;

            if(!name || !id) return alert("Name and ID required");
            
            try {
                await CareData.addPatient({ id, name, diagnosis, status, sleepHours: [7,7,7,7,7,7,7] });
                hydrateStats();
                renderPatients();
                populateAnalysisSelect();
                selectAnalysis(id); // Switch to new patient
                closeAddPatient();
            } catch (e) {
                alert(e.message);
            }
        }

        modal.addEventListener('click', (e) => { if (e.target === modal) closeAddPatient(); });
        searchBox.addEventListener('input', (e) => renderPatients(e.target.value));

        function toggleContrast() {
            document.body.classList.toggle('high-contrast');
        }

        // --- INIT ---
        window.onload = function() {
            hydrateStats();
            renderPatients();
            populateAnalysisSelect();
        };
    </script>
</body>
</html>